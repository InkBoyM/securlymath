<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>GitHub &amp; BitBucket HTML Preview</title>
    <style>
        body {
            font: 12px 'Helvetica Neue', Helvetica, Arial, freesans, clean, sans-serif;
            color: #333;
        }
        h1 {
            font-size: 20px;
        }
        a {
            color: #666;
        }
        #previewform {
            padding: 20px; 
            text-align: center;
        }
        strong {
            color: #333;
            background-color: #FAFFA6;
            padding: 0.1em;
        }
        #footer {
            margin: 20px 0;
            font-size: 10px;
            color: #666;
        }
    </style>
</head>
<body>
    <form id="previewform" onsubmit="previewSite(); return false;">
        <h1>GitHub &amp; BitBucket HTML Preview</h1>
        <p>
            Enter URL of the HTML file to preview:
            <input type="url" id="file" value="" placeholder="e.g. https://github.com/user/repo/blob/master/index.html" size="60" autofocus>
            <input type="submit" value="Preview">
        </p>
        <p>or prepend to the URL: <code><strong>http://htmlpreview.github.io/?</strong>https://github.com/twbs/bootstrap/blob/gh-pages/2.3.2/index.html</code></p>
        <p id="footer">Developed by <a href="https://github.com/niutech">niu tech</a> | Contribute on <a href="https://github.com/htmlpreview/htmlpreview.github.com">GitHub</a></p>
    </form>
    <script>
        (function () {
            var previewForm = document.getElementById('previewform');
            
            function fetchProxy(url, options, i) {
                var proxy = [
                    '', // try without proxy first
                    'https://api.codetabs.com/v1/proxy/?quest='
                ];
                return fetch(proxy[i] + url, options).then(function (res) {
                    if (!res.ok) throw new Error('Cannot load ' + url + ': ' + res.status + ' ' + res.statusText);
                    return res.text();
                }).catch(function (error) {
                    if (i === proxy.length - 1) throw error;
                    return fetchProxy(url, options, i + 1);
                });
            }

            function loadHTML(data, url) {
                if (data) {
                    data = data.replace(/<head([^>]*)>/i, '<head$1><base href="' + url + '">')
                        .replace(/<script(\s*src=["'][^"']*["'])?(\s*type=["'](text|application)\/javascript["'])?/gi, 
                        '<script type="text/htmlpreview"$1');
                    setTimeout(function () {
                        document.open();
                        document.write(data);
                        document.close();
                    }, 10);
                }
            }
            
            function rewriteLinks() {
                document.querySelectorAll('a[href]').forEach(link => {
                    let originalUrl = link.href;
                    link.href = `https://www.securlymath.com/proxy.htm/?${encodeURIComponent(originalUrl)}`;
                });
            }
            
            window.previewSite = function () {
                var url = document.getElementById('file').value;
                if (url) {
                    url = url.replace(/\/\/github\.com/, '//raw.githubusercontent.com').replace(/\/blob\//, '/');
                    fetchProxy(url, null, 0).then(function (data) {
                        loadHTML(data, url);
                        setTimeout(rewriteLinks, 1000); // Ensure links are rewritten after loading
                    }).catch(function (error) {
                        console.error(error);
                        previewForm.style.display = 'block';
                        previewForm.innerText = error;
                    });
                }
            };
        })();
    </script>
</body>
</html>
